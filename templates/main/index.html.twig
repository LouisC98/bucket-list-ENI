{% extends 'base.html.twig' %}

{% block title %}Home | {{ parent() }}{% endblock %}

{% block body %}
<section class="mx-auto px-2 pt-5 pb-16" data-turbo="false">
    <h2 class="text-4xl text-center font-semibold my-4">Ceci est la page d'accueil !</h2>
        <div class="text-center my-6">
            <a href="{{ path('app_wish_new') }}" class="btn-primary p-3">Nouveau souhait</a>
        </div>

        <div class="text-center">
            <span class="text-lg font-semibold me-4">Trier :</span>
            <label for="searchInput" class="me-2">Rechercher </label>
            <input type="text" name="searchInput" id="searchInput" class="p-1 border rounded">
        </div>

        <div id="wishesContainer">
            {% include 'main/_wishes_list.html.twig' %}
        </div>
</section>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('turbo:load', function() {
            let searchTimeout;

            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    console.log(searchTerm);
                    fetch(`{{ path('app_wish_search') }}?search=${encodeURIComponent(searchTerm)}`,  {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('wishesContainer').innerHTML = html;
                        });
                }, 300);

            });

            document.getElementById('wishesContainer').addEventListener('click', function(e) {
                if (e.target.hasAttribute('data-wish-url')) {
                    const btn = e.target;
                    fetch(btn.dataset.wishUrl, { method: 'PATCH' })
                        .then(response => response.json())
                        .then(data => {
                            btn.textContent = data.isCompleted ? '✅' : '❌';
                        });
                }
            });
        });
    </script>
{% endblock %}